<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ÂïèÁ≠îÊåëÊà∞</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background-color: #f0f2f5;
      color: #333;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }
    .container {
      background-color: #fff;
      padding: 20px 40px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 700px;
    }
    h1, h2 {
      text-align: center;
      color: #0056b3;
    }
    input[type="text"] {
      width: calc(100% - 22px);
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 16px;
    }
    button {
      display: block;
      width: 100%;
      padding: 12px;
      font-size: 16px;
      color: #fff;
      background-color: #007bff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.2s;
      margin-top: 10px;
    }
    button:hover:not(:disabled) {
      background-color: #0056b3;
    }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    #langSelection button {
        margin-bottom: 10px;
    }
    #quizForm .question-block {
      margin-bottom: 25px;
      padding: 15px;
      border: 1px solid #eee;
      border-radius: 8px;
    }
    #quizForm label {
      display: block;
      margin: 8px 0;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ddd;
      cursor: pointer;
      transition: background-color 0.2s, border-color 0.2s;
    }
    #quizForm label:hover {
      background-color: #f5f5f5;
    }
    .error-message {
      color: red;
      text-align: center;
      margin-top: 10px;
      font-weight: bold;
    }
    #resultContainer h2 {
      color: #28a745;
    }
    .result-summary p {
      font-size: 1.1em;
      line-height: 1.6;
    }
    .correct-answer {
      border-color: #28a745 !important;
      background-color: #e9f7ef;
      color: #155724;
    }
    .wrong-answer {
      border-color: #dc3545 !important;
      background-color: #f8d7da;
      color: #721c24;
    }
    .indicator {
        font-weight: bold;
        float: right;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 data-lang-key="quizTitle">ÂïèÁ≠îÊåëÊà∞</h1>

    <!-- Ë™ûË®ÄÈÅ∏ÊìáÂçÄ -->
    <div id="langSelection">
        <h2>Ë´ãÈÅ∏ÊìáË™ûË®Ä / Please Select Language</h2>
        <button onclick="selectLang('zh')">‰∏≠Êñá</button>
        <button onclick="selectLang('en')">English</button>
    </div>

    <!-- Ë∫´‰ªΩËº∏ÂÖ•ÂçÄ -->
    <div id="userInfo" style="display:none;">
      <h2 data-lang-key="userInfoTitle">Ë´ãËº∏ÂÖ•ÊÇ®ÁöÑË≥áË®ä</h2>
      <label><span data-lang-key="userIdLabel">Â∑•Ëôü</span>Ôºö<input type="text" id="userId" required></label>
      <label><span data-lang-key="userNameLabel">ÂßìÂêç</span>Ôºö<input type="text" id="userName" required></label>
      <button onclick="startQuiz()" data-lang-key="startQuizBtn">ÈñãÂßãÁ≠îÈ°å</button>
      <div id="startError" class="error-message"></div>
    </div>

    <!-- È°åÁõÆÂçÄ -->
    <div id="quizContainer" style="display:none;">
      <form id="quizForm"></form>
      <button id="submitBtn" onclick="submitQuiz()" data-lang-key="submitBtn">Êèê‰∫§Á≠îÊ°à</button>
      <div id="validationMessage" class="error-message"></div>
    </div>

    <!-- ÁµêÊûúÂçÄ -->
    <div id="resultContainer" style="display:none;">
      <!-- ÁµêÊûúÂ∞áÊúÉÂãïÊÖãÊ≥®ÂÖ•Ê≠§Ëôï -->
    </div>
  </div>

  <script>
    const apiResultsUrl = '/api/quiz-results';

    const translations = {
      en: {
        quizTitle: "Quiz Challenge",
        userInfoTitle: "Please Enter Your Information",
        userIdLabel: "Employee ID",
        userNameLabel: "Name",
        startQuizBtn: "Start Quiz",
        startError: "Please enter Employee ID and Name",
        loadingMsg: "Loading questions...",
        submitBtn: "Submit Answers",
        validationMsg: (count) => `You have ${count} unanswered questions!`,
        resultTitle: "Quiz Results",
        resultUserId: "Employee ID",
        resultUserName: "Name",
        resultScore: "Score",
        resultRate: "Correct Rate",
        tryAgainBtn: "Try Again",
        fetchError: (status) => `Failed to load questions, server error: ${status}`,
        noQuestionsError: "No questions available in the question bank.",
        genericError: (msg) => `Error: ${msg}`,
        correctIndicator: " Correct Answer",
        yourChoiceIndicator: " Your Choice",
        perfectScoreError: "You have already achieved a 100% score for this category and cannot retake the quiz.",
        statusCheckError: "Could not verify your eligibility. Please try again later.",
        perfectScoreMessage: "Congratulations! You've achieved a perfect score!",
        notYouPrompt: (name) => `Not ${name || 'you'}? <a href='#' onclick='bypassIpCheckAndStart(event)'>Click here to take the quiz.</a>`
      },
      zh: {
        quizTitle: "ÂïèÁ≠îÊåëÊà∞",
        userInfoTitle: "Ë´ãËº∏ÂÖ•ÊÇ®ÁöÑË≥áË®ä",
        userIdLabel: "Â∑•Ëôü",
        userNameLabel: "ÂßìÂêç",
        startQuizBtn: "ÈñãÂßãÁ≠îÈ°å",
        startError: "Ë´ãËº∏ÂÖ•Â∑•ËôüËàáÂßìÂêç",
        loadingMsg: "È°åÁõÆËºâÂÖ•‰∏≠...",
        submitBtn: "Êèê‰∫§Á≠îÊ°à",
        validationMsg: (count) => `ÊÇ®ÈÇÑÊúâ ${count} È°åÊú™‰ΩúÁ≠îÔºÅ`,
        resultTitle: "Á≠îÈ°åÁµêÊûú",
        resultUserId: "Â∑•Ëôü",
        resultUserName: "ÂßìÂêç",
        resultScore: "Á≠îÂ∞çÈ°åÊï∏",
        resultRate: "Ê≠£Á¢∫Áéá",
        tryAgainBtn: "ÂÜçË©¶‰∏ÄÊ¨°",
        fetchError: (status) => `ÁÑ°Ê≥ïËºâÂÖ•È°åÁõÆÔºå‰º∫ÊúçÂô®ÈåØË™§: ${status}`,
        noQuestionsError: "È°åÂ∫´‰∏≠Ê≤íÊúâÈ°åÁõÆÂèØ‰æõÊ∏¨È©ó„ÄÇ",
        genericError: (msg) => `ÈåØË™§: ${msg}`,
        correctIndicator: " Ê≠£Á¢∫Á≠îÊ°à",
        yourChoiceIndicator: " ÊÇ®ÁöÑÈÅ∏Êìá",
        perfectScoreError: "ÊÇ®Â∑≤Âú®Ê≠§ÂàÜÈ°ûÈÅîÂà∞100%Ê≠£Á¢∫ÁéáÔºåÁÑ°ÈúÄÈáçË§á‰ΩúÁ≠î„ÄÇ",
        statusCheckError: "ÁÑ°Ê≥ïÈ©óË≠âÊÇ®ÁöÑ‰ΩúÁ≠îË≥áÊ†ºÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ",
        perfectScoreMessage: "ÊÅ≠ÂñúÔºÅÊÇ®Â∑≤ÂÆåÁæéÈÄöÈóúÔºÅ",
        notYouPrompt: (name) => `‰∏çÊòØ ${name || 'ÊÇ®'} ÂóéÔºü<a href='#' onclick='bypassIpCheckAndStart(event)'>ÈªûÊ≠§ÈñãÂßã‰ΩúÁ≠î„ÄÇ</a>`
      }
    };

    const state = {
      questions: [],
      user: { id: '', name: '' },
      isSubmitted: false,
      lang: 'zh',
      category: null // Will be populated from URL
    };

    function getQueryParam(param) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
    }

    function showInitialPerfectScoreScreen(lang, userName) {
        const t = translations[lang];
        updateUIText(lang);
        document.getElementById('langSelection').style.display = 'none';
        document.getElementById('userInfo').style.display = 'none';
        document.getElementById('quizContainer').style.display = 'none';
        const resultContainer = document.getElementById('resultContainer');
        resultContainer.innerHTML = `
          <div class="result-summary">
            <h2 style="font-size: 3em;">üéâ</h2>
            <p style="text-align:center; font-weight:bold; font-size: 1.2em; color: #28a745;">
              ${t.perfectScoreMessage}
            </p>
            <p style="text-align:center; color: #666;">
              ${t.perfectScoreError}
            </p>
            <p style="text-align:center; font-size: 0.9em; margin-top: 20px;">
              ${t.notYouPrompt(userName)}
            </p>
          </div>
        `;
        resultContainer.style.display = 'block';
    }

    function bypassIpCheckAndStart(event) {
        event.preventDefault();
        document.getElementById('resultContainer').style.display = 'none';
        document.getElementById('langSelection').style.display = 'block';
        document.title = "ÂïèÁ≠îÊåëÊà∞";
    }

    async function checkInitialStatus() {
      state.category = getQueryParam('category');
      // Only perform the IP check if a category is specified in the URL
      if (!state.category) {
        return;
      }

      try {
        const res = await fetch(`${apiResultsUrl}/status/ip?category=${encodeURIComponent(state.category)}`);
        if (!res.ok) {
          console.warn('IP status check failed, proceeding normally.');
          return;
        }

        const data = await res.json();
        if (data.canTakeQuiz === false) {
          const lang = data.lang || 'zh';
          const userName = data.userName || '';
          showInitialPerfectScoreScreen(lang, userName);
        }
      } catch (error) {
        console.error('Initial status check failed:', error);
      }
    }

    function shuffleArray(array) {
      let currentIndex = array.length, randomIndex;
      while (currentIndex !== 0) {
        randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex--;
        [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
      }
      return array;
    }

    function selectLang(lang) {
        state.lang = lang;
        document.getElementById('langSelection').style.display = 'none';
        document.getElementById('userInfo').style.display = 'block';
        updateUIText(lang);
    }

    function updateUIText(lang) {
        const t = translations[lang];
        document.querySelectorAll('[data-lang-key]').forEach(el => {
            const key = el.dataset.langKey;
            if (t[key]) {
                el.textContent = t[key];
            }
        });
        document.title = t.quizTitle;
    }

    async function startQuiz() {
      state.user.id = document.getElementById('userId').value.trim();
      state.user.name = document.getElementById('userName').value.trim();
      const startError = document.getElementById('startError');
      const t = translations[state.lang];

      if (!state.user.id || !state.user.name) {
        startError.textContent = t.startError;
        return;
      }
      startError.textContent = '';

      try {
        let statusApiUrl = `${apiResultsUrl}/status/${encodeURIComponent(state.user.id)}`;
        if (state.category) {
            statusApiUrl += `?category=${encodeURIComponent(state.category)}`;
        }
        const statusRes = await fetch(statusApiUrl);
        if (!statusRes.ok) throw new Error('Server status check failed');
        const statusData = await statusRes.json();
        if (statusData.canTakeQuiz === false) {
          startError.textContent = t.perfectScoreError;
          return;
        }
      } catch (error) {
        console.error('Error checking quiz status:', error);
        startError.textContent = t.statusCheckError;
        return;
      }

      document.getElementById('userInfo').style.display = 'none';
      const quizContainer = document.getElementById('quizContainer');
      const quizForm = document.getElementById('quizForm');
      quizContainer.style.display = 'block';
      quizForm.innerHTML = `<p>${t.loadingMsg}</p>`;

      try {
        let questionApiUrl;
        const questionCount = 10;
        if (state.category) {
            questionApiUrl = `/api/questions/category/${encodeURIComponent(state.category)}/random?count=${questionCount}&lang=${state.lang}`;
        } else {
            questionApiUrl = `/api/questions/random?count=${questionCount}&lang=${state.lang}`;
        }

        const res = await fetch(questionApiUrl);
        if (!res.ok) throw new Error(t.fetchError(res.status));
        
        state.questions = await res.json();
        if (state.questions.length === 0) throw new Error(t.noQuestionsError);

        quizForm.innerHTML = '';

        state.questions.forEach((q, index) => {
          const options = [...q.options];
          const correctAnswerText = options[q.answerIndex];
          shuffleArray(options);
          const newAnswerIndex = options.indexOf(correctAnswerText);
          q.shuffledOptions = options;
          q.correctShuffledIndex = newAnswerIndex;

          const optionsHtml = options.map((opt, i) => `
            <label>
              <input type="radio" name="q${index}" value="${i}" required>
              ${opt}
            </label>
          `).join('');

          quizForm.innerHTML += `
            <div class="question-block">
              <strong>Q${index + 1}: ${q.question}</strong><br>
              ${optionsHtml}
            </div>
          `;
        });
      } catch (error) {
        quizForm.innerHTML = `<p class="error-message">${t.genericError(error.message)}</p>`;
        document.getElementById('submitBtn').style.display = 'none';
      }
    }

    function submitQuiz() {
      if (state.isSubmitted) return;

      const form = document.getElementById('quizForm');
      const validationMessage = document.getElementById('validationMessage');
      const t = translations[state.lang];
      
      const totalAnswered = form.querySelectorAll('input[type="radio"]:checked').length;
      if (totalAnswered < state.questions.length) {
        validationMessage.textContent = t.validationMsg(state.questions.length - totalAnswered);
        return;
      }
      validationMessage.textContent = '';
      state.isSubmitted = true;

      let score = 0;
      const userAnswers = [];

      state.questions.forEach((q, index) => {
        const selectedInput = form.querySelector(`input[name="q${index}"]:checked`);
        const selectedIndex = parseInt(selectedInput.value, 10);
        userAnswers.push(selectedIndex);

        const isCorrect = selectedIndex === q.correctShuffledIndex;
        if (isCorrect) {
          score++;
        }

        const optionLabels = form.querySelectorAll(`input[name="q${index}"]`);
        optionLabels.forEach((radio, i) => {
          const label = radio.parentElement;
          radio.disabled = true;

          if (i === q.correctShuffledIndex) {
            label.classList.add('correct-answer');
            const indicatorSpan = document.createElement('span');
            indicatorSpan.className = 'indicator';
            indicatorSpan.textContent = '‚úÖ' + t.correctIndicator;
            label.appendChild(indicatorSpan);
          } 
          else if (i === selectedIndex && !isCorrect) {
            label.classList.add('wrong-answer');
            const indicatorSpan = document.createElement('span');
            indicatorSpan.className = 'indicator';
            indicatorSpan.textContent = '‚ùå' + t.yourChoiceIndicator;
            label.appendChild(indicatorSpan);
          }
        });
      });

      document.getElementById('submitBtn').disabled = true;

      const percent = parseFloat(((score / state.questions.length) * 100).toFixed(1));
      const resultContainer = document.getElementById('resultContainer');
      
      let actionHtml = '';
      if (score < state.questions.length) {
        actionHtml = `<button onclick="resetQuiz()" data-lang-key="tryAgainBtn">${t.tryAgainBtn}</button>`;
      } else {
        actionHtml = `<p style="text-align:center; font-weight:bold; color: #28a745;">${t.perfectScoreMessage}</p>`;
      }

      resultContainer.innerHTML = `
        <div class="result-summary">
          <h2 data-lang-key="resultTitle">${t.resultTitle}</h2>
          <p><strong>${t.resultUserId}Ôºö</strong>${state.user.id}</p>
          <p><strong>${t.resultUserName}Ôºö</strong>${state.user.name}</p>
          <p><strong>${t.resultScore}Ôºö</strong>${score} / ${state.questions.length}</p>
          <p><strong>${t.resultRate}Ôºö</strong>${percent}%</p>
        </div>
        ${actionHtml}
      `;
      resultContainer.style.display = 'block';
      resultContainer.scrollIntoView({ behavior: 'smooth' });

      sendResultsToServer(score, userAnswers, percent);
    }

    async function sendResultsToServer(score, answers, correctRate) {
      try {
        await fetch(apiResultsUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userId: state.user.id,
            userName: state.user.name,
            score: score,
            total: state.questions.length,
            correctRate: correctRate,
            answers: answers,
            lang: state.lang,
            category: state.category
          })
        });
      } catch (error) {
        console.error('ÂÇ≥ÈÄÅÁµêÊûúÊôÇÁôºÁîüÁ∂≤Ë∑ØÈåØË™§:', error);
      }
    }

    function resetQuiz() {
      window.location.reload();
    }

    window.addEventListener('DOMContentLoaded', checkInitialStatus);
  </script>
</body>
</html>
